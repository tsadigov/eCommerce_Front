<!DOCTYPE html>
<html lang="en" dir="ltr">
  
  <head>
    <meta charset="utf-8">
    <title>Add product</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" 
      rel="stylesheet" 
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" 
      crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="styles/index-style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  
  <body>
    
    <!-- Header -->
    <header></header>

    <!-- Body -->
    <div class="container">
        <div class="btn btn-info mt-2" style="color: aliceblue; font-weight: bold;" data-toggle="modal" data-target="#addProductModal">Məhsul əlavə et</div>
        <!-- <input type="checkbox" name="" id=""> -->
        <div class="col-10 p-2" id="product-list">
        </div>  
    </div>


    <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Məhsul əlavə et</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="form" enctype="multipart/form-data" class="container mb-5">
                        <div class="form-group mb-2">
                            <label for="first-name">Məhsul üçün şəkil</label>
                            <input id="product-image" type="file" name="product-image" accept="image/png" class="form-control" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="product-name">Məhsulun adı</label>
                            <input type="text" class="form-control" name="prod-name" id="prod-name" placeholder="Məhsulun adı" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="cost">Qiyməti</label>
                            <input type="number" step="any" class="form-control" name="cost" id="cost" placeholder="Qiyməti" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="amount">Miqdarı</label>
                            <input type="number" class="form-control" name="amount" id="amount" placeholder="Miqdarı" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="details">Əlavə məlumatlar</label>
                            <input type="text" class="form-control" name="details" id="details" placeholder="Əlavə məlumatlar" required>
                        </div>
                        <div class="form-group mb-4">
                            <label for="subcategory">Alt Kateqoriya:</label><br>
                            <select name="subcategory" id="subcategory" class="form-control">
                            </select>
                        </div>
                        <div>
                            <span class="float-right">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bağla</button>
                                <button type="submit" class="btn btn-primary">Yadda saxla</button>
                            </span>
                        </div>
                    </form >
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="updateProductModal" tabindex="-1" role="dialog" aria-labelledby="updateProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateProductModalLabel">Yenilə</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="form2" enctype="multipart/form-data" class="container mb-5">
                        <input type="number" id="refresh-product-id" hidden>
                        <div class="form-group mb-2">
                            <label for="refresh-product-image">Məhsul üçün şəkil</label>
                            <input id="refresh-product-image" type="file" name="product-image" accept="image/png" class="form-control" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="refresh-prod-name">Məhsulun adı</label>
                            <input type="text" class="form-control" name="prod-name" id="refresh-prod-name" placeholder="Məhsulun adı" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="refresh-cost">Qiyməti</label>
                            <input type="number" step="any" class="form-control" name="cost" id="refresh-cost" placeholder="Qiyməti" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="refresh-amount">Miqdarı</label>
                            <input type="number" class="form-control" name="amount" id="refresh-amount" placeholder="Miqdarı" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="refresh-details">Əlavə məlumatlar</label>
                            <input type="text" class="form-control" name="details" id="refresh-details" placeholder="Əlavə məlumatlar" required>
                        </div>
                        <div class="form-group mb-4">
                            <label for="refresh-subcategory">Alt Kateqoriya:</label><br>
                            <select name="subcategory" id="refresh-subcategory" class="form-control">
                            </select>
                        </div>
                        <div>
                            <span class="float-right">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Bağla</button>
                                <button type="submit" class="btn btn-primary">Yenilə</button>
                            </span>
                        </div>
                    </form >
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="./js/constants.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <script type="text/javascript" src="./js/product.js"></script>

    <!-- Save product -->
    <script>
          
      var url = ipAddress.ip + '/api/product/add';
      var url2 = ipAddress.ip + '/api/product';

      const form = document.getElementById("form");
      const form2 = document.getElementById("form2");
      const productImage = document.getElementById("product-image");
      const productImage2 = document.getElementById("refresh-product-image");
      
      const formData = new FormData();

      const handleSubmit = (event) => {
        event.preventDefault();

        productName = document.getElementById("prod-name").value;
        cost = document.getElementById("cost").value;
        amount = document.getElementById("amount").value;
        details = document.getElementById("details").value;
        subcategory = document.getElementById("subcategory").value;

        
        for (const file of productImage.files) {
          if(!isFileImage(file)){
            alert("Seçilmiş fayl şəkil formatında olmalıdır!");
            window.location.reload();
          }  
          formData.append("file", file);
        }
        formData.append("product-name", productName);
        formData.append("cost", cost);
        formData.append("amount", amount);
        formData.append("storeId", sessionStorage["storeId"]);
        formData.append("subcategory", subcategory);
        formData.append("details", details);

        console.log(productName," ",cost, " ", amount, " ", details);

        fetch(url, {
            method: "POST",
            body: formData,
        })
        .then(function() {
          console.log("ok");
          window.location.reload();
        })
        .catch((error) => ("Couldn't add product!", error));
      };

      const handleUpdateSubmit = (event) => {
        event.preventDefault();

        productId = document.getElementById("refresh-product-id").value;
        productName = document.getElementById("refresh-prod-name").value;
        cost = document.getElementById("refresh-cost").value;
        amount = document.getElementById("refresh-amount").value;
        details = document.getElementById("refresh-details").value;
        subcategory = document.getElementById("refresh-subcategory").value;

        for (const file of productImage2.files) {
          if(!isFileImage(file)){
            alert("Seçilmiş fayl şəkil formatında olmalıdır!");
            window.location.reload();
          }  
          formData.append("file", file);
        }
        formData.append("product-id", productId);
        formData.append("product-name", productName);
        formData.append("cost", cost);
        formData.append("amount", amount);
        formData.append("storeId", sessionStorage["storeId"]);
        formData.append("subcategory", subcategory);
        formData.append("details", details);

        console.log("Update: " , productId," ",productName," ",cost, " ", amount, " ", details);

        fetch(url2, {
            method: "PUT",
            body: formData,
        })
        .then(function() {
          console.log("Updated");
        //   window.location.reload();
        })
        .catch((error) => ("Couldn't update product!", error));
      };


      form.addEventListener("submit", handleSubmit);
      form2.addEventListener("submit", handleUpdateSubmit);

      function isFileImage(file) {
        return file && file['type'].split('/')[0] === 'image';
      }
    </script>


  </body>
</html>
